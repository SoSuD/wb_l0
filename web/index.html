<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Order Lookup</title>
    <style>
        :root { --bg:#0b0d12; --fg:#e6e9ef; --muted:#9aa4b2; --card:#121620; --accent:#5b9cff; --ok:#37d399; --err:#ff6b6b; --border:#1e2430; }
        @media (prefers-color-scheme: light) {
            :root { --bg:#f6f7fb; --fg:#0b1220; --muted:#576171; --card:#ffffff; --accent:#2f6feb; --ok:#139c5a; --err:#d83a3a; --border:#e6e8ee; }
        }
        * { box-sizing: border-box; }
        body {
            margin: 0; background: radial-gradient(1200px 600px at 80% -10%, rgba(91,156,255,.15), transparent 70%), var(--bg);
            color: var(--fg); font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
            min-height: 100dvh; display: grid; place-items: center; padding: 24px;
        }
        .card {
            width: 100%; max-width: 820px; background: var(--card); border: 1px solid var(--border);
            border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.15);
        }
        .header { display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom: 14px; }
        h1 { font-size: 20px; margin: 0; letter-spacing:.2px; }
        .row { display:flex; gap:10px; align-items:center; }
        input[type="text"] {
            flex:1; padding: 12px 14px; border-radius: 12px; border: 1px solid var(--border); outline: none;
            background: transparent; color: var(--fg);
        }
        input::placeholder { color: var(--muted); }
        button {
            appearance: none; border: 1px solid var(--border); background: var(--accent); color: #fff;
            padding: 12px 16px; border-radius: 12px; cursor: pointer; font-weight: 600;
            transition: transform .03s ease, filter .2s ease, opacity .2s ease;
        }
        button.secondary { background: transparent; color: var(--fg); }
        button:active { transform: translateY(1px); }
        .meta { margin-top: 10px; color: var(--muted); font-size: 13px; display:flex; gap:10px; flex-wrap: wrap;}
        .meta .ok { color: var(--ok); }
        .meta .err { color: var(--err); }
        .panel {
            margin-top: 14px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: transparent;
        }
        .panel-header { padding: 10px 12px; display:flex; gap:8px; align-items:center; justify-content:space-between; border-bottom: 1px solid var(--border); }
        .panel-header span { color: var(--muted); font-size: 13px; }
        pre {
            margin: 0; padding: 14px; max-height: 60dvh; overflow: auto;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
            font-size: 13px; line-height: 1.45; white-space: pre-wrap; word-break: break-word;
        }
        .spinner {
            width: 16px; height: 16px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,.25); border-top-color: #fff; display: inline-block;
            animation: spin .8s linear infinite; vertical-align: -2px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hint { margin-top: 6px; color: var(--muted); font-size: 12px; }
        .badge { font-size: 12px; padding: 2px 8px; border-radius: 999px; border:1px solid var(--border); color: var(--muted); }
        .footer { margin-top: 10px; display:flex; justify-content: space-between; align-items:center; }
        a.link { color: var(--accent); text-decoration: none; }
    </style>
</head>
<body>
<div class="card">
    <div class="header">
        <h1>Order Lookup</h1>
        <span class="badge">GET /order/&lt;order_uid&gt;</span>
    </div>

    <div class="row">
        <input id="uid" type="text" placeholder="Введите order_uid, например 91f1a2..." autocomplete="off" />
        <button id="go">Запросить</button>
    </div>
    <div class="hint">Бекенд: <code>http://localhost:8082/order/&lt;order_uid&gt;</code></div>

    <div class="meta" id="meta"></div>

    <div class="panel">
        <div class="panel-header">
            <span id="status">Готово</span>
            <div class="row">
                <button id="copy" class="secondary" title="Скопировать ответ">Копировать</button>
                <button id="clear" class="secondary" title="Очистить">Очистить</button>
            </div>
        </div>
        <pre id="out">Ответ появится здесь…</pre>
    </div>

    <div class="footer">
        <span class="hint">Подсказка: нажмите Enter в поле ввода</span>
        <a class="link" href="#" id="testLink">Открыть в новом окне (raw)</a>
    </div>
</div>

<script>
    const base = "http://localhost:8082/order/";
    const $uid = document.getElementById("uid");
    const $go = document.getElementById("go");
    const $status = document.getElementById("status");
    const $meta = document.getElementById("meta");
    const $out = document.getElementById("out");
    const $copy = document.getElementById("copy");
    const $clear = document.getElementById("clear");
    const $testLink = document.getElementById("testLink");

    // Восстановим последний UID
    $uid.value = localStorage.getItem("last_uid") || "";

    function setLink(uid) {
        const url = base + encodeURIComponent(uid || "");
        $testLink.href = url;
    }
    setLink($uid.value);

    function setStatus(text, isLoading = false, isError = false) {
        if (isLoading) $status.innerHTML = '<span class="spinner"></span> ' + text;
        else $status.textContent = text;
        $status.style.color = isError ? 'var(--err)' : 'inherit';
    }

    function renderMeta(items = []) {
        $meta.innerHTML = items.map(x => {
            const cls = x.ok ? 'ok' : x.err ? 'err' : '';
            return `<span class="${cls}">${x.label}: ${x.value}</span>`;
        }).join("");
    }

    function pretty(data, contentType) {
        try {
            if (typeof data === "string") {
                // Попробуем распарсить как JSON, если это текст с JSON
                if (contentType && contentType.includes("application/json")) {
                    return JSON.stringify(JSON.parse(data), null, 2);
                }
                return data;
            }
            return JSON.stringify(data, null, 2);
        } catch {
            return String(data);
        }
    }

    async function fetchOrder() {
        const uid = $uid.value.trim();
        setLink(uid);
        if (!uid) {
            setStatus("Введите order_uid", false, true);
            return;
        }
        localStorage.setItem("last_uid", uid);

        // Таймаут 10s
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), 10_000);

        const url = base + encodeURIComponent(uid);
        const started = performance.now();
        setStatus("Выполняю запрос…", true);
        renderMeta([{label:"URL", value:url}]);
        $out.textContent = "";

        try {
            const res = await fetch(url, {
                method: "GET",
                signal: controller.signal,
                headers: { "Accept": "application/json, text/plain;q=0.8, */*;q=0.5" },
            });
            clearTimeout(timer);

            const ct = res.headers.get("content-type") || "";
            let bodyText;
            try {
                bodyText = ct.includes("application/json") ? JSON.stringify(await res.json()) : await res.text();
            } catch (e) {
                // Если тело пустое/битое
                bodyText = await res.text().catch(() => "");
            }

            const ms = Math.round(performance.now() - started);
            renderMeta([
                {label:"Статус", value: res.status + " " + res.statusText, ok: res.ok, err: !res.ok},
                {label:"Время", value: ms + " ms"},
                {label:"Тип", value: ct || "—"},
                {label:"Размер", value: (new Blob([bodyText]).size) + " B"},
            ]);

            setStatus(res.ok ? "Готово" : "Ошибка ответа", false, !res.ok);
            $out.textContent = pretty(bodyText, ct);
        } catch (err) {
            clearTimeout(timer);
            const ms = Math.round(performance.now() - started);
            const aborted = err?.name === "AbortError";
            setStatus(aborted ? "Таймаут запроса" : "Ошибка запроса", false, true);
            renderMeta([
                {label:"Статус", value: aborted ? "timeout" : "network/error", err: true},
                {label:"Время", value: ms + " ms"},
                {label:"URL", value: url},
            ]);
            $out.textContent = String(err);
        }
    }

    $go.addEventListener("click", fetchOrder);
    $uid.addEventListener("keydown", (e) => { if (e.key === "Enter") fetchOrder(); });
    $copy.addEventListener("click", async () => {
        try {
            await navigator.clipboard.writeText($out.textContent);
            setStatus("Ответ скопирован");
            setTimeout(() => setStatus("Готово"), 1000);
        } catch {
            setStatus("Не удалось скопировать", false, true);
        }
    });
    $clear.addEventListener("click", () => { $out.textContent = ""; setStatus("Очищено"); renderMeta([]); });

</script>
</body>
</html>
